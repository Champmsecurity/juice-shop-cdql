name: "security Scan"

on:
  push:
  pull_request:

jobs:
  codeql:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript-typescript' ]
    steps:
    - name: Checkout repository
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 #v4.2.2
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        queries: security-extended
        config: |
          paths-ignore:
            - 'data/static/codefixes'
    - name: Autobuild
      uses: github/codeql-action/autobuild@v3
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3




  semgrep:
    runs-on: ubuntu-latest
    name: 🛡️ SAST-Semgrep
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Run Semgrep
        uses: returntocorp/semgrep-action@fcd5ab7459e8d91cb1777481980d1b18b4fc6735
        with:
          Config: auto
          generateSarif: "1"
        continue-on-error: true
      - name: Upload SARIF file
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
          
  code_scanning:
    runs-on: ubuntu-latest
    name: 🛡️ SAST-Codescanning
    needs: [codeql,semgrep]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Fetch Code Scanning Alerts
        run: |
          echo "[]" > code-scanning-alerts.json
          for page in {1..10}; do
            resp=$(curl -s -H "Authorization: token ${{secrets.PAT_TOKEN}}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/Champmsecurity/juice-shop_Ghas/code-scanning/alerts?per_page=100&page=$page")
            count=$(echo "$resp" | jq length)
            if [ "$count" -eq 0 ]; then break; fi
            jq -s '.[0] + .[1]' code-scanning-alerts.json <(echo "$resp") > tmp.json
            mv tmp.json code-scanning-alerts.json
            if [ "$count" -lt 100 ]; then break; fi
          done
      - name: Upload Code Scanning Alerts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: code-scanning-alerts
          path: code-scanning-alerts.json
